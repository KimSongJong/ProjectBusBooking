# ============================================
# DOCKER COMPOSE FOR BUS BOOKING SYSTEM
# ============================================
# Simple setup - Just run: docker-compose up
# ============================================

version: '3.8'

services:
  # ============================================
  # DATABASE SERVICE (MySQL 8.0)
  # ============================================
  # IMPORTANT: Container name MUST match application.properties datasource URL
  # application.properties uses: jdbc:mysql://bus-booking-db:3306/bus_booking
  database:
    image: mysql:8.0
    container_name: bus-booking-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: bus_booking
      MYSQL_USER: busbooking_user
      MYSQL_PASSWORD: busbooking_pass
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "3306:3306"  # MySQL port (change to 3307 if you have XAMPP running)
    volumes:
      - mysql_data:/var/lib/mysql
      - ./bus_booking.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - bus-booking-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # phpMyAdmin (Database Management Tool)
  # ============================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: bus-booking-phpmyadmin
    restart: unless-stopped
    depends_on:
      - database
    environment:
      PMA_HOST: bus-booking-db
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: root_password
      UPLOAD_LIMIT: 500M
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "8081:80"  # Access at http://localhost:8081
    networks:
      - bus-booking-network

  # ============================================
  # BACKEND SERVICE (Spring Boot + Maven)
  # ============================================
  backend:
    image: maven:3.9-eclipse-temurin-21
    container_name: bus-booking-backend
    restart: unless-stopped
    working_dir: /app
    depends_on:
      database:
        condition: service_healthy
    environment:
      # Database connection (MUST use container name 'bus-booking-db' - same as application.properties)
      SPRING_DATASOURCE_URL: jdbc:mysql://bus-booking-db:3306/bus_booking?useSSL=false&serverTimezone=Asia/Ho_Chi_Minh&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: busbooking_user
      SPRING_DATASOURCE_PASSWORD: busbooking_pass

      # JPA settings
      SPRING_JPA_HIBERNATE_DDL_AUTO: none
      SPRING_JPA_SHOW_SQL: true

      # Server settings
      SERVER_PORT: 8080
      SERVER_SERVLET_CONTEXT_PATH: /api

      # Email settings (Gmail)
      SPRING_MAIL_HOST: smtp.gmail.com
      SPRING_MAIL_PORT: 587
      SPRING_MAIL_USERNAME: 12345levan@gmail.com
      SPRING_MAIL_PASSWORD: mtxgodtqrqqvpjaf

      # VNPay settings
      VNPAY_TMN_CODE: 8VWGGMPI
      VNPAY_SECRET_KEY: BNSRMWY0L44Q4YO7MGUFM47OYXLGLZ08
      VNPAY_API_URL: https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
      VNPAY_RETURN_URL: http://localhost:5173/payment/result

      # MoMo settings
      MOMO_PARTNER_CODE: MOMOBKUN20180529
      MOMO_ACCESS_KEY: klm05TvNBzhg7h7j
      MOMO_SECRET_KEY: at67qH6mk8w5Y1nAyMoYKMWACiEi2bsa
      MOMO_API_URL: https://test-payment.momo.vn/v2/gateway/api/create
      MOMO_RETURN_URL: http://localhost:5173/payment/result
      MOMO_NOTIFY_URL: http://localhost:8080/api/payment/momo/ipn

      # Google Maps API
      GOOGLE_MAPS_API_KEY: AIzaSyDqREwt7ParWxOVdKPEFskIqmp002__3fQ

      # Cloudinary settings
      CLOUDINARY_CLOUD_NAME: dncl2jdhn
      CLOUDINARY_API_KEY: 379943491161338
      CLOUDINARY_API_SECRET: nURaL0Ui2AhPTdN0bBZoO_KjS5M

      # JWT settings
      APP_JWT_SECRET: dGhpc0lzQVZlcnlTZWNyZXRLZXlGb3JKV1RUb2tlbkdlbmVyYXRpb25JbkJ1c0Jvb2tpbmdTeXN0ZW0xMjM0NTY3ODk=
      APP_JWT_EXPIRATION: 86400000

      # CORS settings
      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://localhost:3000

      # Maven options
      MAVEN_OPTS: "-Xmx1024m"
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "8080:8080"
    networks:
      - bus-booking-network
    volumes:
      # Mount source code for hot reload (development mode)
      - ./backend/src:/app/src:ro
      - ./backend/pom.xml:/app/pom.xml:ro
      - maven_cache:/root/.m2
      - ./backend/logs:/app/logs
    command: >
      bash -c "
        echo 'ðŸš€ Starting Backend...';
        mvn clean spring-boot:run
      "

  # ============================================
  # FRONTEND SERVICE (React + Vite + Node.js)
  # ============================================
  frontend:
    image: node:20-alpine
    container_name: bus-booking-frontend
    restart: unless-stopped
    working_dir: /app
    depends_on:
      - backend
    environment:
      VITE_API_URL: http://localhost:8080/api
      NODE_ENV: development
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "5173:5173"  # Vite dev server
    networks:
      - bus-booking-network
    volumes:
      # Mount source code for hot reload
      - ./frontend-react/src:/app/src
      - ./frontend-react/public:/app/public
      - ./frontend-react/index.html:/app/index.html
      - ./frontend-react/package.json:/app/package.json
      - ./frontend-react/vite.config.ts:/app/vite.config.ts
      - ./frontend-react/tsconfig.json:/app/tsconfig.json
      - ./frontend-react/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend-react/tsconfig.node.json:/app/tsconfig.node.json
      - ./frontend-react/tailwind.config.js:/app/tailwind.config.js
      - ./frontend-react/postcss.config.js:/app/postcss.config.js
      - node_modules_cache:/app/node_modules
    command: >
      sh -c "
        echo 'ðŸš€ Installing dependencies...';
        npm install;
        echo 'ðŸš€ Starting Vite dev server...';
        npm run dev -- --host 0.0.0.0
      "

# ============================================
# NETWORKS
# ============================================
networks:
  bus-booking-network:
    driver: bridge
    name: bus-booking-net

# ============================================
# VOLUMES (Persistent data)
# ============================================
volumes:
  mysql_data:
    name: bus-booking-mysql-data
  maven_cache:
    name: bus-booking-maven-cache
  node_modules_cache:
    name: bus-booking-node-modules

