<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug: Payment Redirect Issue</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        .section {
            background: #252526;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007acc;
        }
        .section h2 {
            margin-top: 0;
            color: #dcdcaa;
        }
        .log-entry {
            background: #1e1e1e;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #569cd6;
            font-size: 12px;
            word-wrap: break-word;
        }
        .log-entry.error {
            border-left-color: #f48771;
            background: #2d1a1a;
        }
        .log-entry.success {
            border-left-color: #4ec9b0;
            background: #1a2d25;
        }
        .log-entry.warning {
            border-left-color: #dcdcaa;
            background: #2d2a1a;
        }
        .timestamp {
            color: #858585;
            font-size: 11px;
        }
        .key {
            color: #9cdcfe;
        }
        .value {
            color: #ce9178;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #404040;
        }
        .button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .button:hover {
            background: #005a9e;
        }
        .button.danger {
            background: #f48771;
        }
        .button.danger:hover {
            background: #d16d5c;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.checking {
            background: #dcdcaa;
            color: #1e1e1e;
        }
        .status.success {
            background: #4ec9b0;
            color: #1e1e1e;
        }
        .status.error {
            background: #f48771;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug: Round Trip Payment Redirect Issue</h1>

        <div class="section">
            <h2>üìä Current Status</h2>
            <p>Status: <span class="status checking" id="status">Monitoring...</span></p>
            <p>Last Check: <span id="lastCheck">-</span></p>
            <p>Console Logs Captured: <span id="logCount">0</span></p>
        </div>

        <div class="section">
            <h2>üéØ What to do:</h2>
            <ol>
                <li>Keep this tab open</li>
                <li>Go to <code>http://localhost:5173/booking-seat?outboundTripId=310&returnTripId=292&tripType=roundTrip</code></li>
                <li>Select seats and click "Thanh to√°n"</li>
                <li>Come back to this tab to see captured logs</li>
            </ol>
            <button class="button" onclick="startMonitoring()">Start Monitoring</button>
            <button class="button danger" onclick="clearLogs()">Clear Logs</button>
            <button class="button" onclick="exportLogs()">Export Logs</button>
        </div>

        <div class="section">
            <h2>üìù Captured Console Logs</h2>
            <div id="logs">
                <p style="color: #858585;">No logs captured yet. Start monitoring and trigger the payment flow.</p>
            </div>
        </div>

        <div class="section">
            <h2>üíæ SessionStorage Data</h2>
            <button class="button" onclick="checkSessionStorage()">Check SessionStorage</button>
            <pre id="sessionData">Click button to check...</pre>
        </div>

        <div class="section">
            <h2>üîó Navigation History</h2>
            <pre id="navHistory">No navigation history yet...</pre>
        </div>

        <div class="section">
            <h2>üìã Expected Flow</h2>
            <div class="log-entry">
                <span class="key">STEP 1:</span> <span class="value">Frontend sends request to /api/tickets/round-trip</span>
            </div>
            <div class="log-entry">
                <span class="key">STEP 2:</span> <span class="value">Backend creates 2 tickets + booking_group_id</span>
            </div>
            <div class="log-entry">
                <span class="key">STEP 3:</span> <span class="value">Backend returns response with success=true, bookingGroupId=BOOKING_...</span>
            </div>
            <div class="log-entry">
                <span class="key">STEP 4:</span> <span class="value">Frontend receives response</span>
            </div>
            <div class="log-entry">
                <span class="key">STEP 5:</span> <span class="value">Frontend checks: response.bookingGroupId exists? ‚Üí YES</span>
            </div>
            <div class="log-entry success">
                <span class="key">STEP 6:</span> <span class="value">Frontend saves paymentData to sessionStorage</span>
            </div>
            <div class="log-entry success">
                <span class="key">STEP 7:</span> <span class="value">Frontend calls navigate("/payment")</span>
            </div>
            <div class="log-entry success">
                <span class="key">EXPECTED:</span> <span class="value">Page navigates to /payment (URL changes)</span>
            </div>
            <div class="log-entry error">
                <span class="key">ACTUAL (BUG):</span> <span class="value">Page reloads (URL stays same or error thrown)</span>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        let monitoring = false;
        let navHistory = [];

        // Intercept console methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function captureLog(type, args) {
            const timestamp = new Date().toLocaleTimeString('vi-VN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3
            });

            const message = Array.from(args).map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            logs.push({ type, timestamp, message });
            updateLogsDisplay();
        }

        console.log = function(...args) {
            if (monitoring) captureLog('log', args);
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            if (monitoring) captureLog('error', args);
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            if (monitoring) captureLog('warning', args);
            originalWarn.apply(console, args);
        };

        function startMonitoring() {
            monitoring = true;
            document.getElementById('status').textContent = 'Monitoring Active';
            document.getElementById('status').className = 'status success';

            // Monitor navigation
            const originalPushState = history.pushState;
            const originalReplaceState = history.replaceState;

            history.pushState = function(...args) {
                navHistory.push({
                    type: 'pushState',
                    timestamp: new Date().toISOString(),
                    url: args[2]
                });
                updateNavHistory();
                return originalPushState.apply(history, args);
            };

            history.replaceState = function(...args) {
                navHistory.push({
                    type: 'replaceState',
                    timestamp: new Date().toISOString(),
                    url: args[2]
                });
                updateNavHistory();
                return originalReplaceState.apply(history, args);
            };

            window.addEventListener('beforeunload', function(e) {
                navHistory.push({
                    type: 'beforeunload',
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                });
                updateNavHistory();
            });

            alert('‚úÖ Monitoring started! Go to booking page and complete the payment flow.');
        }

        function updateLogsDisplay() {
            const logsDiv = document.getElementById('logs');
            document.getElementById('logCount').textContent = logs.length;
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString('vi-VN');

            if (logs.length === 0) {
                logsDiv.innerHTML = '<p style="color: #858585;">No logs captured yet.</p>';
                return;
            }

            logsDiv.innerHTML = logs.map(log => {
                const className = log.type === 'error' ? 'error' :
                                 log.type === 'warning' ? 'warning' :
                                 log.message.includes('‚úÖ') || log.message.includes('SUCCESS') ? 'success' : '';

                return `
                    <div class="log-entry ${className}">
                        <span class="timestamp">[${log.timestamp}]</span>
                        <pre style="margin: 5px 0 0 0; white-space: pre-wrap;">${log.message}</pre>
                    </div>
                `;
            }).join('');

            // Auto scroll to bottom
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateNavHistory() {
            const navDiv = document.getElementById('navHistory');
            if (navHistory.length === 0) {
                navDiv.textContent = 'No navigation history yet...';
                return;
            }

            navDiv.textContent = JSON.stringify(navHistory, null, 2);
        }

        function clearLogs() {
            if (confirm('Clear all logs?')) {
                logs = [];
                navHistory = [];
                updateLogsDisplay();
                updateNavHistory();
            }
        }

        function exportLogs() {
            const data = {
                logs,
                navHistory,
                sessionStorage: checkSessionStorageData(),
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payment-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function checkSessionStorageData() {
            const data = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                try {
                    data[key] = JSON.parse(sessionStorage.getItem(key));
                } catch (e) {
                    data[key] = sessionStorage.getItem(key);
                }
            }
            return data;
        }

        function checkSessionStorage() {
            const data = checkSessionStorageData();
            document.getElementById('sessionData').textContent = JSON.stringify(data, null, 2);
        }

        // Auto-check every 2 seconds
        setInterval(() => {
            if (monitoring) {
                document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString('vi-VN');
            }
        }, 2000);
    </script>
</body>
</html>

